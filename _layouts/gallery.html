<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>{{ page.title }} – An Average Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>

    <style>
        html {
            overflow-y: scroll;
            scrollbar-gutter: stable;
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #fff;
            color: #111;
            display: flex;
            flex-direction: column;
        }

        .gallery-container {
            flex: 1;
            display: flex;
            min-height: 0;
            /* Prevent flex container overflow shifting */
        }


        .sidebar {
            width: 250px;
            padding: 20px;
            border-right: 1px solid #eee;
            position: sticky;
            /* Already present — keep it */
            top: 80px;
            /* Match navbar height */
            height: calc(100vh - 80px);
            /* Full height minus navbar */
            overflow-y: auto;
            background: #fafafa;
            transition: transform 0.3s ease;
            z-index: 10;
            min-width: 250px;
            /* Prevent shrinking */
            box-sizing: border-box;
            overflow-y: auto;
            overflow-x: hidden;
            /* Prevent horizontal scrollbar */
        }


        #sidebar-toggle {
            position: fixed;
            top: 70px;
            /* or 80px depending on navbar height */
            background: white;
            border: 1px solid #ccc;
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            left: 20px;
            transition: left 0.3s ease-in-out;
        }

        body.sidebar-visible #sidebar-toggle {
            left: 270px;
            /* Sidebar width + margin */
        }

        .sidebar:not(.collapsed)~#sidebar-toggle {
            left: 270px;
            /* Slightly offset from sidebar edge */
        }



        /* When sidebar is hidden, move button to left edge */
        body.sidebar-hidden #sidebar-toggle {
            left: 10px;
        }



        .sidebar.collapsed {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            position: absolute;
            background: white;
            height: 100vh;
            z-index: 50;
        }


        .gallery-wrapper {
            flex: 1;
            padding: 40px 20px 20px 20px;
            /* extra top padding */
            min-width: 0;
            min-height: 70vh;
        }



        .grid {
            display: block;
        }

        .grid-sizer,
        .grid-item {
            width: 25%;
        }

        .grid-item {
            margin-bottom: 5px;
            padding: 5px;
            box-sizing: border-box;
        }

        .grid-item img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            aspect-ratio: attr(data-aspect-ratio);
        }

        .grid-item:hover img {
            transform: scale(1.02);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        @media (max-width: 1200px) {

            .grid-sizer,
            .grid-item {
                width: 50%;
            }

            .sidebar-toggle {
                left: 20px;
            }
        }

        @media (max-width: 768px) {

            .grid-sizer,
            .grid-item {
                width: 100%;
            }
        }

        .sidebar h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #111;
        }

        #tag-filter {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
        }

        #tag-filter input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            accent-color: #111;
            vertical-align: middle;
        }

        #tag-filter label {
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: color 0.2s ease;
            font-weight: 400;
            /* Prevent bold on check */
        }

        #tag-filter input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #111;
            /* styled checkboxes if browser supports */
        }

        #tag-filter label:hover {
            color: #000;
        }
    </style>
</head>

<body>
    {% include navbar.html %}
    <button id="sidebar-toggle" onclick="toggleSidebar()">☰ Show Filter</button>
    <div class="gallery-container">
        <!-- Sidebar Toggle Button -->

        <!-- Sidebar -->
        <aside class="sidebar collapsed" id="sidebar">
            <h3>Filter by Tag</h3>
            <form id="tag-filter">
                {% assign tag_string = "" %}
                {% for image in site.image_info %}
                {% if image.tags %}
                {% for tag in image.tags %}
                {% assign tag_clean = tag | strip | downcase %}
                {% unless tag_string contains tag_clean %}
                {% assign tag_string = tag_string | append: tag_clean | append: "||" %}
                {% endunless %}
                {% endfor %}
                {% endif %}
                {% endfor %}

                {% assign tag_array = tag_string | split: "||" | sort %}

                {% for tag in tag_array %}
                {% unless tag == "" %}
                <div class="tag-checkbox">
                    <label>
                        <input type="checkbox" name="tag" value="{{ tag }}">
                        {{ tag | capitalize }}
                    </label>
                </div>
                {% endunless %}
                {% endfor %}
            </form>

        </aside>


        <!-- Gallery -->
        <div class="gallery-wrapper">
            <div class="grid">
                <div class="grid-sizer"></div>
                {% for image in site.image_info %}
                {% assign filename_base = image.filename | split: '.' | first %}
                {% assign webp = '/assets/images/gallery_light/' | append: filename_base | append: '.webp' %}
                {% assign full = '/assets/images/gallery/' | append: image.filename %}
                {% if image.tags %}
                {% assign tag_string = image.tags | join: ' ' | downcase %}
                {% else %}
                {% assign tag_string = '' %}
                {% endif %}

                <div class="grid-item" data-tags="{{ tag_string }}">

                    <a href="{{ full }}" class="glightbox" data-gallery="gallery">
                        <picture>
                            <source srcset="{{ webp }}" type="image/webp" />
                            <img src="{{ webp }}" alt="{{ image.description | default: image.title }}" loading="lazy"
                                decoding="async" style="aspect-ratio: {{ image.ratio | default: '3/2' }};">
                        </picture>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>


    <script>
        let msnry;
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const isCollapsed = sidebar.classList.toggle('collapsed');

            toggleBtn.textContent = isCollapsed ? '☰ Show Filter' : '☰ Hide Filter';

            document.body.classList.toggle('sidebar-visible', !isCollapsed);

            setTimeout(() => {
                msnry.layout();
            }, 350);
        }








        document.addEventListener("DOMContentLoaded", () => {
            const grid = document.querySelector(".grid");
            msnry = new Masonry(grid, {
                itemSelector: ".grid-item",
                columnWidth: ".grid-sizer",
                percentPosition: true,
                gutter: 0
            });


            imagesLoaded(grid).on("progress", () => msnry.layout());

            GLightbox({ selector: ".glightbox" });

            const checkboxes = document.querySelectorAll('#tag-filter input[type="checkbox"]');
            checkboxes.forEach(checkbox =>
                checkbox.addEventListener("change", () => {
                    const activeTags = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value.toLowerCase());

                    document.querySelectorAll(".grid-item").forEach(item => {
                        const tags = item.dataset.tags.toLowerCase().split(" ");
                        const show = activeTags.length === 0 || activeTags.every(tag => tags.includes(tag));
                        item.style.display = show ? "block" : "none";
                    });

                    msnry.layout();
                })
            );
        });
    </script>
</body>

</html>